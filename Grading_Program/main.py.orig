import re
import time
import queue
import datetime
import mysql.connector
from multiprocessing import Process
from Gui import App
from Grader import Grader
from ThreadGrader import ThreadGrader
from SubmissionWatcher import SubmissionWatcher
from watchdog.observers import Observer
import threading

def main(args):
  #create a queue
  q = queue.Queue()
  done = []

  #connect to mysql server
  try:
    conf = {
      'user'    : args['username'],
      'password': args['password'],
      'host'    : args['host'],
      'database': args['database']
    }

    cnx = mysql.connector.connect(conf)
  except Error as e:
    print(e)

  #file watcher
  observer = Observer()
<<<<<<< HEAD
  observer.schedule(SubmissionWatcher(), path=args['submission'])
  print(args['submission'])
  observer.start()

  #grader manager
  grade_manager = ThreadGrader(q, cnx,
                               args['table'],
=======
  observer.schedule(SubmissionWatcher(cnx), path=args['submission'])
  observer.start()

  #grader manager
  grade_manager = ThreadGrader(q, cnx, done,
                               arg['table'],
>>>>>>> 5aad2253c6d809f8761fd5b0862c5f90d46c7735
                               args['problems'])
  grade_manager.setDaemon(True) #do not exit until all things needed
  grade_manager.start()         #  to be graded are graded, and start it

<<<<<<< HEAD
  #wait until end of compitition
  p = Prompt(args['end_time'])
  p.start()
  while datetime.datetime.now() < p.end:
    sec = (p.end - datetime.datetime.now()).seconds
    h   = int(sec / 3600)
    m   = int(sec / 60) % 60
    s   = int(sec % 60)
    print('\r{:02}:{:02}:{:02} > {}'.format(h, m, s, p.command), end='')
    time.sleep(0.1)
=======
  #TODO - istatiate/start GUI
  app = App(observer, q, done, args['end_time'])
  app.mainloop()

  #close mysql
  cnx.close()
>>>>>>> 5aad2253c6d809f8761fd5b0862c5f90d46c7735

  #end watchdog
  observer.stop()
  observer.join()
